"use client"

import type React from "react"

import { Button } from "@/components/ui/button"
import { Card } from "@/components/ui/card"
import { useState, useMemo, useEffect, useRef } from "react"
import type { DashboardStats, HypePrice, BuybackData, RevenueData, TokenInfo } from "@/lib/types/hyperliquid"
import { reformatCurrency } from "@/lib/utils/format"
import { ExternalLink } from "lucide-react"
import dayjs from "dayjs"

type UIProject = {
  id: string
  name: string
  logo?: string
  categories: string[] // <- Now always an array
  website?: string
  social?: string
  description?: string
  handle?: string
  tags?: string[]
  links?: {
    website?: string
    twitter?: string
    social?: string
  }
}

const LS_KEY = "hl_admin_projects"

function mapAdminProject(p: any, idx: number): UIProject {
  // Support both old (category: string) and new (categories: string[]) formats
  const catsRaw = p?.categories ?? p?.category ?? p?.tags ?? []
  const cats = Array.isArray(catsRaw) ? catsRaw : catsRaw ? [catsRaw] : []

  return {
    id: p?.id ?? `admin-${idx}`,
    name: p?.name ?? p?.title ?? "Untitled",
    handle: p?.handle ?? p?.twitter ?? "",
    website: p?.website ?? p?.links?.website ?? "",
    social: p?.social ?? p?.links?.social ?? "",
    description: p?.description ?? "",
    logo: p?.logo ?? "",
    tags: p?.tags ?? [],
    categories: cats,
    links: {
      website: p?.website ?? p?.links?.website,
      twitter: p?.twitter ? `https://x.com/${p.twitter.replace(/^@/, "")}` : undefined,
      social:
        p?.social ??
        p?.links?.social ??
        (p?.website ? (p.website.startsWith("http") ? p.website : `https://${p.website}`) : undefined),
    },
  }
}

function readAdminProjects(): any[] {
  const keys = ["hl_admin_projects", "hyper_admin_projects", "adminProjects"]
  for (const key of keys) {
    try {
      const raw = localStorage.getItem(key)
      if (!raw) continue
      const arr = JSON.parse(raw)
      if (Array.isArray(arr) && arr.length > 0) return arr
    } catch {}
  }
  return []
}

function toHttp(s?: string) {
  if (!s) return ""
  // 支持直接写域名，如 "apstation.io"
  return /^https?:\/\//i.test(s) ? s : `https://${s}`
}

interface DashboardClientProps {
  stats: DashboardStats
  hypePrice: HypePrice
  buybackData: BuybackData[]
  revenueData: RevenueData[]
  hotTokens: TokenInfo[]
  topGainers: TokenInfo[]
  newTokens: TokenInfo[]
}

interface DefiLlamaRevenueData {
  totalDataChart: [number, number][]
}

function niceTick(target: number): number {
  if (target <= 0) return 1
  const exponent = Math.floor(Math.log10(target))
  const power = Math.pow(10, exponent)
  const normalized = target / power
  const niceValues = [1, 2, 2.5, 5, 10]
  let bestValue = niceValues[0]
  let minDiff = Math.abs(normalized - bestValue)
  for (const value of niceValues) {
    const diff = Math.abs(normalized - value)
    if (diff < minDiff) {
      minDiff = diff
      bestValue = value
    }
  }
  if (bestValue === 10) return power * 10
  return bestValue * power
}

function formatRevenue(value: number): string {
  if (value >= 1_000_000_000) return `$${(value / 1_000_000_000).toFixed(1)}b`
  if (value >= 1_000_000) return `$${(value / 1_000_000).toFixed(1)}m`
  if (value >= 1_000) return `$${(value / 1_000).toFixed(1)}k`
  return `$${value.toFixed(0)}`
}

function formatVolume(value: number | undefined): string {
  const num = Number(value ?? 0)
  if (isNaN(num) || num === 0) return "$0"
  if (num >= 1_000_000_000) return `$${(num / 1_000_000_000).toFixed(2)}B`
  if (num >= 1_000_000) return `$${(num / 1_000_000).toFixed(2)}M`
  if (num >= 1_000) return `$${(num / 1_000).toFixed(1)}K`
  return `$${num.toFixed(0)}`
}

function TruncatedDescription({
  text,
  maxLines = 3,
  onMore,
}: {
  text: string
  maxLines?: 2 | 3 | 4
  onMore: () => void
}) {
  const pRef = useRef<HTMLParagraphElement | null>(null)
  const [isOverflow, setIsOverflow] = useState(false)

  const clampClass = maxLines === 2 ? "line-clamp-2" : maxLines === 4 ? "line-clamp-4" : "line-clamp-3"

  useEffect(() => {
    const el = pRef.current
    if (!el) return

    const check = () => setIsOverflow(el.scrollHeight > el.clientHeight + 1)

    // Check in next frame and after resize
    check()
    const raf = requestAnimationFrame(check)

    const ro = new ResizeObserver(check)
    ro.observe(el)

    return () => {
      cancelAnimationFrame(raf)
      ro.disconnect()
    }
  }, [text, maxLines])

  return (
    <div>
      <p ref={pRef} className={`text-[11px] leading-relaxed text-[#96fce4]/90 lg:text-[10px] ${clampClass}`}>
        {text}
      </p>

      {isOverflow && (
        <button
          type="button"
          onClick={onMore}
          className="mt-1 text-[11px] text-[#43e5c9] hover:underline lg:text-[10px]"
        >
          展开全文
        </button>
      )}
    </div>
  )
}

export default function DashboardClient({
  stats,
  hypePrice,
  buybackData,
  revenueData,
  hotTokens,
  topGainers,
  newTokens,
}: DashboardClientProps) {
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false)
  const [timePeriod, setTimePeriod] = useState<"month" | "day">("month")
  const [currentRevenueData, setCurrentRevenueData] = useState<RevenueData[]>(revenueData)
  const [isLoading, setIsLoading] = useState(false)
  const [hoveredBar, setHoveredBar] = useState<number | null>(null)
  const [activeCategory, setActiveCategory] = useState("全部")

  // 分页（每页 9 项）
  const [currentPage, setCurrentPage] = useState(1)
  const [goToPage, setGoToPage] = useState("")
  const itemsPerPage = 9

  const [defiLlamaRevenue, setDefiLlamaRevenue] = useState<DefiLlamaRevenueData | null>(null)
  const [revenueLoading, setRevenueLoading] = useState(true)

  const [hlTopVolume, setHlTopVolume] = useState<TokenInfo[]>([])

  const [displayPrice, setDisplayPrice] = useState(hypePrice.current)
  const [displayChange, setDisplayChange] = useState(hypePrice.change24h)
  const [isDragging, setIsDragging] = useState(false)
  const [hoveredPoint, setHoveredPoint] = useState<{
    x: number
    y: number
    price: number
    ts: number
    i: number
  } | null>(null)

  const chartRef = useRef<SVGSVGElement>(null)

  const [allProjects, setAllProjects] = useState<UIProject[]>([])

  const [descModal, setDescModal] = useState<{ open: boolean; title: string; text: string }>({
    open: false,
    title: "",
    text: "",
  })

  useEffect(() => {
    const rawProjects = readAdminProjects()

    if (rawProjects.length === 0) {
      setAllProjects([])
      return
    }

    const mapped = rawProjects.map(mapAdminProject)

    setAllProjects(mapped)

    // Listen for storage events from other tabs
    const onStorage = (e: StorageEvent) => {
      if (e.key === LS_KEY) {
        const updated = readAdminProjects()
        if (updated.length > 0) {
          setAllProjects(updated.map(mapAdminProject))
        } else {
          setAllProjects([])
        }
      }
    }
    window.addEventListener("storage", onStorage)
    return () => window.removeEventListener("storage", onStorage)
  }, [])

  useEffect(() => {
    const fetchTopVolumePerps = async () => {
      try {
        const res = await fetch("https://api.hyperliquid.xyz/info", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type: "metaAndAssetCtxs" }),
        })
        if (!res.ok) {
          return
        }

        const json = await res.json()

        const universe = json?.[0]?.universe ?? []
        const ctxs = json?.[1] ?? []

        const rows: TokenInfo[] = universe.map((u: any, i: number) => {
          const c = ctxs[i] || {}
          const mark = Number.parseFloat(c.markPx ?? "0")
          const prev = Number.parseFloat(c.prevDayPx ?? (mark || "0"))
          const vol = Number.parseFloat(c.dayNtlVlm ?? "0")
          const changePct = prev > 0 ? ((mark - prev) / prev) * 100 : 0

          return {
            name: u.name,
            price: mark.toFixed(5),
            change24h: Number(changePct.toFixed(2)),
            // @ts-ignore
            volume24h: vol,
          }
        })

        rows.sort((a: any, b: any) => (b.volume24h ?? 0) - (a.volume24h ?? 0))
        const top10 = rows.slice(0, 10)

        setHlTopVolume(top10)
      } catch (e) {
        console.error("fetchTopVolumePerps error:", e)
      }
    }

    fetchTopVolumePerps()
  }, [])

  useEffect(() => {
    const fetchDefiLlamaRevenue = async () => {
      setRevenueLoading(true)
      try {
        const response = await fetch("/api/defillama-revenue")
        if (response.ok) {
          const data = await response.json()
          setDefiLlamaRevenue({
            totalDataChart: data.totalDataChart || [],
          })
        } else {
          console.error("DefiLlama API returned error:", response.status)
        }
      } catch (error) {
        console.error("Error fetching DefiLlama revenue:", error)
      } finally {
        setRevenueLoading(false)
      }
    }

    fetchDefiLlamaRevenue()
  }, [])

  useEffect(() => {
    const fetchRevenueData = async () => {
      setIsLoading(true)
      try {
        const response = await fetch(`/api/revenue?timeView=${timePeriod}`)
        if (response.ok) {
          const data = await response.json()
          setCurrentRevenueData(data)
        }
      } catch (error) {
        console.error("Error fetching revenue data:", error)
      } finally {
        setIsLoading(false)
      }
    }

    fetchRevenueData()
  }, [timePeriod])

  const { yMax, yTicks } = useMemo(() => {
    if (!currentRevenueData || currentRevenueData.length === 0) {
      return { yMax: 10_000_000, yTicks: [10_000_000, 7_500_000, 5_000_000, 2_500_000, 0] }
    }

    const maxDataValue = Math.max(...currentRevenueData.flatMap((d) => [d.fees, d.revenue]))
    const tick = niceTick(maxDataValue / 6)
    const calculatedYMax = Math.ceil(maxDataValue / tick) * tick
    const numTicks = Math.ceil(calculatedYMax / tick) + 1
    const ticks = Array.from({ length: numTicks }, (_, i) => calculatedYMax - i * tick)

    return { yMax: calculatedYMax, yTicks: ticks }
  }, [currentRevenueData])

  const revenueKPIs = useMemo(() => {
    if (!defiLlamaRevenue || !defiLlamaRevenue.totalDataChart || defiLlamaRevenue.totalDataChart.length === 0) {
      return { total24h: 0, total7d: 0, total30d: 0 }
    }

    const data = defiLlamaRevenue.totalDataChart
    const now = new Date()
    const todayUTCStart = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()) / 1000

    const completedDays = data.filter(([timestamp]) => timestamp < todayUTCStart)

    let lastCompletedDay = completedDays.length > 0 ? completedDays[completedDays.length - 1] : null
    if (!lastCompletedDay || lastCompletedDay[1] === 0) {
      for (let i = data.length - 1; i >= 0; i--) {
        if (data[i][1] > 0) {
          lastCompletedDay = data[i]
          break
        }
      }
    }

    const last30Days = completedDays.slice(-30)
    const last7Days = completedDays.slice(-7)

    return {
      total24h: lastCompletedDay ? lastCompletedDay[1] : 0,
      total7d: last7Days.reduce((sum, [_, value]) => sum + value, 0),
      total30d: last30Days.reduce((sum, [_, value]) => sum + value, 0),
    }
  }, [defiLlamaRevenue])

  const revenueChartData = useMemo(() => {
    if (!defiLlamaRevenue || !defiLlamaRevenue.totalDataChart || defiLlamaRevenue.totalDataChart.length === 0) {
      return { data: [], yMax: 10_000_000, yTicks: [] }
    }

    const last30Days = defiLlamaRevenue.totalDataChart.slice(-30)
    const maxValue = Math.max(...last30Days.map(([_, value]) => value))
    const tick = niceTick(maxValue / 6)
    const calculatedYMax = Math.ceil(maxValue / tick) * tick
    const numTicks = Math.ceil(calculatedYMax / tick) + 1
    const ticks = Array.from({ length: numTicks }, (_, i) => calculatedYMax - i * tick)

    return {
      data: last30Days,
      yMax: calculatedYMax,
      yTicks: ticks,
    }
  }, [defiLlamaRevenue])

  const chartPoints = useMemo(() => {
    if (hypePrice.chartData.length === 0) return []

    const W = 400
    const H = 100

    // Normalize timestamp (auto-detect seconds vs milliseconds)
    const normTs = (ts: number) => (String(ts).length === 10 ? ts * 1000 : ts)

    // Sort and clean data
    const series = hypePrice.chartData
      .filter((d) => d && d.price != null && !Number.isNaN(d.price))
      .sort((a, b) => normTs(a.timestamp) - normTs(b.timestamp))

    // Calculate price range
    const minPrice = Math.min(...series.map((d) => d.price))
    const maxPrice = Math.max(...series.map((d) => d.price))
    const priceRange = Math.max(1e-12, maxPrice - minPrice)

    // Map to viewBox coordinates
    return series.map((d, i) => {
      const x = (i / (series.length - 1)) * W
      const y = H - ((d.price - minPrice) / priceRange) * H
      return { x, y, ts: normTs(d.timestamp), price: d.price, i }
    })
  }, [hypePrice.chartData])

  const pickPoint = (e: React.MouseEvent<SVGSVGElement> | React.TouchEvent<SVGSVGElement>) => {
    const svg = chartRef.current
    if (!svg || chartPoints.length === 0) return null

    const rect = svg.getBoundingClientRect()
    const clientX = "touches" in e ? (e.touches?.[0]?.clientX ?? 0) : e.clientX
    let x = clientX - rect.left

    // Map to viewBox coordinates
    x = Math.max(0, Math.min(400, (x / rect.width) * 400))
    const idxFloat = (x / 400) * (chartPoints.length - 1)
    const i = Math.round(idxFloat)

    return chartPoints[i]
  }

  const handleChartInteraction = (e: React.MouseEvent<SVGSVGElement> | React.TouchEvent<SVGSVGElement>) => {
    const point = pickPoint(e)
    if (!point) return

    setHoveredPoint(point)

    const firstPrice = chartPoints[0]?.price ?? point.price
    const changePercent = ((point.price - firstPrice) / firstPrice) * 100

    setDisplayPrice(point.price.toFixed(2))
    setDisplayChange(Number.parseFloat(changePercent.toFixed(2)))
  }

  const handleMouseDown = (e: React.MouseEvent<SVGSVGElement>) => {
    setIsDragging(true)
    handleChartInteraction(e)
  }
  const handleMouseMove = (e: React.MouseEvent<SVGSVGElement>) => {
    if (isDragging) handleChartInteraction(e)
  }
  const handleMouseUp = () => {
    setIsDragging(false)
    setHoveredPoint(null)
    setDisplayPrice(hypePrice.current)
    setDisplayChange(hypePrice.change24h)
  }
  const handleMouseLeave = () => {
    if (isDragging) {
      setIsDragging(false)
      setHoveredPoint(null)
      setDisplayPrice(hypePrice.current)
      setDisplayChange(hypePrice.change24h)
    }
  }
  const handleTouchStart = (e: React.TouchEvent<SVGSVGElement>) => {
    e.preventDefault()
    setIsDragging(true)
    handleChartInteraction(e)
  }
  const handleTouchMove = (e: React.TouchEvent<SVGSVGElement>) => {
    e.preventDefault()
    if (isDragging) handleChartInteraction(e)
  }
  const handleTouchEnd = () => {
    setIsDragging(false)
    setHoveredPoint(null)
    setDisplayPrice(hypePrice.current)
    setDisplayChange(hypePrice.change24h)
  }

  const pricePositionPercent = useMemo(() => {
    const low = Number.parseFloat(hypePrice.low24h)
    const high = Number.parseFloat(hypePrice.high24h)
    const current = Number.parseFloat(displayPrice)
    const range = high - low
    if (range === 0) return 50
    return ((current - low) / range) * 100
  }, [displayPrice, hypePrice.low24h, hypePrice.high24h])

  const { minPrice, maxPrice } = useMemo(() => {
    if (hypePrice.chartData.length === 0) {
      const lastPrice = Number.parseFloat(hypePrice.current)
      return { minPrice: lastPrice * 0.99, maxPrice: lastPrice * 1.01 }
    }
    const prices = hypePrice.chartData.map((p) => p.price)
    return { minPrice: Math.min(...prices) * 0.995, maxPrice: Math.max(...prices) * 1.005 }
  }, [hypePrice.chartData, hypePrice.current])

  // ===== 项目列表 =====

  const categoriesList = [
    "全部",
    "热门",
    "最新",
    "DeFi",
    "基础设施",
    "AI",
    "数据",
    "工具",
    "支付",
    "NFT",
    "迷因币",
    "手机端",
    "社区",
  ]

  // 与顶部大分类完全一致的形状（圆角/边框/内外边距）
  const pillShape = "inline-flex items-center rounded-lg border px-3 py-1.5"
  // 小标签统一的字号与字重（保持清晰）
  const pillTypo = "text-[12px] lg:text-[11px] font-bold"

  // 颜色：复用当前的三种配色（只负责颜色，不改形状）
  const pillHot = "bg-orange-500/10 text-orange-400 border-orange-500/30 hover:bg-orange-500/15"
  const pillLatest = "bg-[#43b8e5]/10 text-[#43b8e5] border-[#43b8e5]/30 hover:bg-[#43b8e5]/15"
  const pillNormal = "bg-[#041713]/70 text-[#43e5c9]/80 border-[#43e5c9]/40"
  // </CHANGE>

  const filteredProjects = useMemo(() => {
    if (activeCategory === "全部") {
      return allProjects
    }

    const filtered = allProjects.filter((p) => {
      const cats = Array.isArray(p.categories) ? p.categories : []
      const fallback = Array.isArray(p.tags) ? p.tags : []
      const matches = cats.includes(activeCategory) || fallback.includes(activeCategory)

      return matches
    })

    return filtered
  }, [allProjects, activeCategory])

  const totalItems = filteredProjects.length
  const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage))
  const startIndex = (currentPage - 1) * itemsPerPage
  const endIndex = Math.min(startIndex + itemsPerPage, totalItems)
  const currentProjects = filteredProjects.slice(startIndex, endIndex)

  useEffect(() => {
    setCurrentPage(1)
  }, [activeCategory])

  useEffect(() => {
    if (currentPage > totalPages) setCurrentPage(1)
  }, [currentPage, totalPages])

  const goToPreviousPage = () => currentPage > 1 && setCurrentPage(currentPage - 1)
  const goToNextPage = () => currentPage < totalPages && setCurrentPage(currentPage + 1)
  const goToSpecificPage = (page: number) => page >= 1 && page <= totalPages && setCurrentPage(page)
  const handleGoToPageSubmit = () => {
    const page = Number.parseInt(goToPage)
    if (!isNaN(page) && page >= 1 && page <= totalPages) {
      setCurrentPage(page)
      setGoToPage("")
    }
  }
  const getVisiblePageNumbers = () => {
    const pages: (number | string)[] = []
    if (totalPages <= 1) return [1]
    pages.push(1)
    if (currentPage > 3) pages.push("...")
    const start = Math.max(2, currentPage - 1)
    const end = Math.min(totalPages - 1, currentPage + 1)
    for (let i = start; i <= end; i++) pages.push(i)
    if (currentPage < totalPages - 2) pages.push("...")
    pages.push(totalPages)
    return pages
  }

  return (
    <div className="grid min-h-screen grid-rows-[auto_auto_1fr_auto] bg-[#010807] text-white lg:min-h-screen">
      {/* 顶部统计栏 */}
      <div className="hidden border-b border-[#072027] bg-[#010807] px-6 py-2.5 lg:block">
        <div className="flex w-full items-center justify-between text-sm">
          <div className="flex items-center gap-8">
            <div className="flex items-center gap-2">
              <span className="text-[#43e5c9]">总市值:</span>
              <span className="font-medium text-white">{reformatCurrency(stats.totalMarketCap)}</span>
            </div>
            <div className="flex items-center gap-2">
              <span className="text-[#43e5c9]">总锁仓:</span>
              <span className="font-medium text-white">{reformatCurrency(stats.totalValueLocked)}</span>
            </div>
            <div className="flex items-center gap-2">
              <span className="text-[#43e5c9]">24小时成交量:</span>
              <span className="font-medium text-white">{reformatCurrency(stats.volume24h)}</span>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <a href="/admin" target="_blank" rel="noopener noreferrer">
              <Button className="h-8 rounded-lg border border-[#43e5c9] bg-transparent px-4 text-sm font-medium text-[#43e5c9] hover:bg-[#43e5c9] hover:text-[#010807] transition-colors">
                管理面板
              </Button>
            </a>
            <a href="https://t.me/chinesehyperliquid" target="_blank" rel="noopener noreferrer">
              <Button className="h-8 rounded-lg bg-[#43e5c9] px-5 text-sm font-medium text-[#010807] hover:bg-[#2da691]">
                加入我们
              </Button>
            </a>
          </div>
        </div>
      </div>

      {/* 顶部导航（保持原样） */}
      <nav className="border-b border-[#072027] bg-[#010807] px-4 py-3 lg:px-6">
        <div className="flex items-center gap-2">
          <div className="flex items-center gap-2 mr-20 md:mr-16 shrink-0">
            <img
              src="https://hyperliquid.gitbook.io/hyperliquid-docs/~gitbook/image?url=https%3A%2F%2F2356094849-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FyUdp569E6w18GdfqlGvJ%252Ficon%252FsIAjqhKKIUysM08ahKPh%252FHL-logoSwitchDISliStat.png%3Falt%3Dmedia%26token%3Da81fa25c-0510-4d97-87ff-3fb8944935b1&width=32&dpr=4&quality=100&sign=3e1219e3&sv=2"
              alt="Hyperliquid Logo"
              className="h-8 w-8 rounded-lg"
            />
            <span className="italic font-semibold text-white">
              Hyperliquid<span className="italic">中文社区</span>
            </span>
          </div>
          <div className="flex flex-1 items-center gap-6">
            <a
              href="https://stats.hyperliquid.xyz/"
              target="_blank"
              className="flex items-center text-sm text-white gap-1 hover:text-[#43e5c9] transition-colors"
              rel="noreferrer"
            >
              Hyperliquid Stats <ExternalLink className="h-3 w-3" />
            </a>
            <a
              href="https://hyperdash.info/"
              target="_blank"
              className="flex items-center flex items-center gap-1 text-sm text-white hover:text-[#43e5c9] transition-colors"
              rel="noreferrer"
            >
              Hyperdash <ExternalLink className="h-3 w-3" />
            </a>
            <a
              href="https://hypurrscan.io/"
              target="_blank"
              className="flex items-center text-sm text-white gap-1 hover:text-[#43e5c9] transition-colors"
              rel="noreferrer"
            >
              Hypurrscan <ExternalLink className="h-3 w-3" />
            </a>
            <a
              href="https://liquidscan.io/"
              target="_blank"
              className="flex items-center flex items-center gap-1 text-sm text-white hover:text-[#43e5c9] transition-colors"
              rel="noreferrer"
            >
              Liquidscan <ExternalLink className="h-3 w-3" />
            </a>
            <a
              href="https://t.me/chinesehyperliquid"
              target="_blank"
              className="flex items-center text-sm text-white hover:text-[#43e5c9] transition-colors"
              rel="noreferrer"
            >
              博客区
            </a>
            <a
              href="/admin"
              target="_blank"
              className="flex items-center text-sm text-[#43e5c9] hover:text-white transition-colors lg:hidden"
              rel="noreferrer"
            >
              管理面板
            </a>
          </div>
        </div>
      </nav>

      <main className="w-full mx-auto px-6 md:px-8 xl:px-10 2xl:px-12 max-w-[1600px] pb-24 overflow-y-auto">
        <div className="py-3 lg:py-5">
          {/* 12 栏网格 */}
          <div className="grid w-full max-w-none grid-cols-1 items-start gap-3 lg:grid-cols-12 lg:gap-4">
            {/* 左：HYPE 价格卡片 */}
            <Card className="col-span-1 min-h-[180px] h-[180px] px-5 py-4 rounded-2xl bg-[#101419] border-[#072027] grid grid-cols-12 gap-3 items-start overflow-hidden lg:col-span-6">
              <div className="col-span-12 flex items-center gap-2 text-[12px] text-[#96fce4]">
                <img
                  src="https://hyperliquid.gitbook.io/hyperliquid-docs/~gitbook/image?url=https%3A%2F%2F2356094849-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FyUdp569E6w18GdfqlGvJ%252Ficon%252FsIAjqhKKIUysM08ahKPh%252FHL-logoSwitchDISliStat.png%3Falt%3Dmedia%26token%3Da81fa25c-0510-4d97-87ff-3fb8944935b1&width=32&dpr=4&quality=100&sign=3e1219e3&sv=2"
                  alt="Hyperliquid Logo"
                  className="h-4 w-4 rounded"
                />
                <span>$HYPE 价格</span>
              </div>

              <div className="col-span-5 flex flex-col relative z-10">
                <div className="mb-1 flex items-baseline gap-2">
                  <span className="text-4xl font-extrabold leading-none tracking-tight text-white">
                    US${Number.parseFloat(displayPrice).toFixed(2)}
                  </span>
                  <div
                    className={`flex items-center gap-1 ${displayChange >= 0 ? "text-[#43e5c9]" : "text-[#e54366]"}`}
                  >
                    <span className="text-sm">{displayChange >= 0 ? "▲" : "▼"}</span>
                    <span className="text-[13px] font-semibold">{Math.abs(displayChange)}%</span>
                  </div>
                </div>

                <div className="mt-2 space-y-2">
                  <div className="flex items-center justify-between text-[11px] text-white">
                    <span>US${Number.parseFloat(hypePrice.low24h).toFixed(2)}</span>
                    <span className="text-[#96fce4]">24小时范围</span>
                    <span>US${Number.parseFloat(hypePrice.high24h).toFixed(2)}</span>
                  </div>
                  <div className="relative h-[8px] w-full overflow-hidden rounded-full bg-[#072027]">
                    <div
                      className="absolute left-0 h-full rounded-full bg-gradient-to-r from-[#e54366] via-[#43e5c9] to-[#43e5c9]"
                      style={{ width: `${pricePositionPercent}%` }}
                    />
                    <div
                      className="absolute top-1/2 h-4 w-4 -translate-x-1/2 -translate-y-1/2 rounded-full border-2 border-white bg-[#43e5c9] shadow-lg"
                      style={{ left: `${pricePositionPercent}%` }}
                    />
                  </div>
                </div>
              </div>

              <div className="col-span-7 relative h-full min-h-[120px] max-h-[160px] overflow-hidden rounded-xl">
                {chartPoints.length === 0 ? (
                  <div className="h-full bg-black/20 animate-pulse rounded-xl" />
                ) : (
                  <svg
                    ref={chartRef}
                    viewBox="0 0 400 100"
                    className="h-full w-full cursor-crosshair"
                    preserveAspectRatio="none"
                    onMouseDown={handleMouseDown}
                    onMouseMove={handleMouseMove}
                    onMouseUp={handleMouseUp}
                    onMouseLeave={handleMouseLeave}
                    onTouchStart={handleTouchStart}
                    onTouchMove={handleTouchMove}
                    onTouchEnd={handleTouchEnd}
                    style={{ touchAction: "none" }}
                  >
                    <defs>
                      <linearGradient id="priceGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stopColor="#43e5c9" stopOpacity="0.4" />
                        <stop offset="100%" stopColor="#43e5c9" stopOpacity="0" />
                      </linearGradient>
                    </defs>
                    <path
                      d={`M 0,100 L ${chartPoints.map((p) => `${p.x},${p.y}`).join(" L ")} L 400,100 Z`}
                      fill="url(#priceGradient)"
                    />
                    <path
                      d={(() => {
                        if (chartPoints.length < 2) return ""
                        let path = `M ${chartPoints[0].x},${chartPoints[0].y}`
                        for (let i = 0; i < chartPoints.length - 1; i++) {
                          const p0 = chartPoints[Math.max(0, i - 1)]
                          const p1 = chartPoints[i]
                          const p2 = chartPoints[i + 1]
                          const p3 = chartPoints[Math.min(chartPoints.length - 1, i + 2)]
                          const cp1x = p1.x + (p2.x - p0.x) / 6
                          const cp1y = p1.y + (p2.y - p0.y) / 6
                          const cp2x = p2.x - (p3.x - p1.x) / 6
                          const cp2y = p2.y - (p3.y - p1.y) / 6
                          path += ` C ${cp1x},${cp1y} ${cp2x},${cp2y} ${p2.x},${p2.y}`
                        }
                        return path
                      })()}
                      fill="none"
                      stroke="#43e5c9"
                      strokeWidth="2.5"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    />
                    {hoveredPoint && (
                      <>
                        <line
                          x1={hoveredPoint.x}
                          y1="0"
                          x2={hoveredPoint.x}
                          y2="100"
                          stroke="#43e5c9"
                          strokeWidth="1"
                          strokeDasharray="2,2"
                          opacity="0.6"
                        />
                        <circle
                          cx={hoveredPoint.x}
                          cy={hoveredPoint.y}
                          r="4"
                          fill="#43e5c9"
                          stroke="#010807"
                          strokeWidth="2"
                        />
                      </>
                    )}
                  </svg>
                )}
                {hoveredPoint && (
                  <div
                    className="pointer-events-none absolute rounded-lg bg-[#010807] px-2 py-1 text-[11px] shadow-lg"
                    style={{
                      left: `${(Math.min(Math.max(hoveredPoint.x, 12), 400 - 12) / 400) * 100}%`,
                      top: `${(Math.min(Math.max(hoveredPoint.y, 12), 100 - 12) / 100) * 100}%`,
                      transform: "translate(-50%, -120%)",
                      border: "1px solid #43e5c9",
                      whiteSpace: "nowrap",
                    }}
                  >
                    <div className="text-[#96fce4]">{dayjs(hoveredPoint.ts).format("YYYY-MM-DD HH:mm")}</div>
                    <div className="font-semibold text-white">US${hoveredPoint.price.toFixed(2)}</div>
                  </div>
                )}
              </div>

              <div className="col-span-12 flex gap-2">
                <Button className="flex-1 rounded-lg border border-[#072027] bg-[#041713] text-[12px] text-white hover:bg-[#072027]">
                  价格
                </Button>
                <Button className="flex-1 rounded-lg border border-[#072027] bg-[#041713] text-[12px] text-white hover:bg-[#072027]">
                  总市值
                </Button>
                <Button className="flex-1 rounded-lg border border-[#072027] bg-[#041713] text-[12px] text-white hover:bg-[#072027]">
                  TradingView
                </Button>
              </div>
            </Card>

            {/* 中：Hyperliquid 收入卡片 */}
            <Card className="col-span-1 min-h-[180px] h-[180px] px-5 py-4 rounded-2xl bg-[#101419] border-[#072027] overflow-hidden lg:col-span-6">
              <div className="mb-2 flex items-center gap-2 text-[13px] text-[#96fce4]">
                <img
                  src="https://hyperliquid.gitbook.io/hyperliquid-docs/~gitbook/image?url=https%3A%2F%2F2356094849-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FyUdp569E6w18GdfqlGvJ%252Ficon%252FsIAjqhKKIUysM08ahKPh%252FHL-logoSwitchDISliStat.png%3Falt%3Dmedia%26token%3Da81fa25c-0510-4d97-87ff-3fb8944935b1&width=32&dpr=4&quality=100&sign=3e1219e3&sv=2"
                  alt="Hyperliquid Logo"
                  className="h-4 w-4 rounded"
                />
                <span>Hyperliquid费用</span>
              </div>

              {revenueLoading ? (
                <div className="flex h-[120px] items-center justify-center">
                  <div className="h-8 w-8 animate-spin rounded-full border-2 border-[#43e5c9] border-t-transparent" />
                </div>
              ) : defiLlamaRevenue && defiLlamaRevenue.totalDataChart.length > 0 ? (
                <div className="grid grid-cols-[minmax(220px,28%)_1fr] xl:grid-cols-[280px_1fr] 2xl:grid-cols-[300px_1fr] gap-4 items-start min-w-0">
                  <div className="flex flex-col gap-1 min-w-0">
                    <div className="flex items-baseline justify-between gap-2 min-w-0 w-full">
                      <span className="text-sm leading-5 text-[#96fce4] truncate">30 日费用</span>
                      <span className="text-lg font-semibold tabular-nums leading-6 text-white whitespace-nowrap">
                        {formatRevenue(revenueKPIs.total30d)}
                      </span>
                    </div>
                    <div className="flex items-baseline justify-between gap-2 min-w-0 w-full">
                      <span className="text-sm leading-5 text-[#96fce4] truncate">7 日费用</span>
                      <span className="text-lg font-semibold tabular-nums leading-6 text-white whitespace-nowrap">
                        {formatRevenue(revenueKPIs.total7d)}
                      </span>
                    </div>
                    <div className="flex items-baseline justify-between gap-2 min-w-0 w-full">
                      <span className="text-sm leading-5 text-[#96fce4] truncate">24 小时费用</span>
                      <span className="text-lg font-semibold tabular-nums leading-6 text-white whitespace-nowrap">
                        {formatRevenue(revenueKPIs.total24h)}
                      </span>
                    </div>
                  </div>

                  <div className="relative min-w-0 flex items-end justify-end h-[110px] overflow-visible">
                    <div className="w-full h-full">
                      {revenueChartData.data.length > 0 && (
                        <svg viewBox="0 0 400 110" className="h-full w-full" preserveAspectRatio="none">
                          {revenueChartData.data.map(([timestamp, value], i) => {
                            const margin = { top: 4, right: 8, bottom: 6, left: 8 }
                            const chartWidth = 400 - margin.left - margin.right
                            const chartHeight = 110 - margin.top - margin.bottom
                            const barGap = 0.18
                            const barWidth = (chartWidth / revenueChartData.data.length) * (1 - barGap)
                            const barSpacing = chartWidth / revenueChartData.data.length
                            const x = margin.left + i * barSpacing + (barSpacing * barGap) / 2
                            const barHeight = (value / revenueChartData.yMax) * chartHeight
                            const y = margin.top + chartHeight - barHeight
                            return (
                              <rect
                                key={i}
                                x={x}
                                y={y}
                                width={barWidth}
                                height={barHeight}
                                fill="#43e5c9"
                                fillOpacity={1}
                                rx="2"
                              />
                            )
                          })}
                        </svg>
                      )}
                    </div>
                  </div>
                </div>
              ) : (
                <div className="flex h-[120px] items-center justify-center text-[#96fce4]">暂无数据</div>
              )}
            </Card>

            {/* 右：代币交易量榜 —— 加宽一格（col-start-10 / col-span-3） */}
            <Card className="col-span-1 h-auto max-w-none overflow-hidden rounded-xl border-[#072027] bg-[#101419] p-4 lg:col-span-3 lg:col-start-10 lg:row-span-2 lg:h-full lg:self-stretch lg:rounded-2xl">
              <div className="mb-3 flex items-center gap-2 text-[13px] text-[#96fce4]">
                <span>📊</span>
                <span>Hyperliquid 今日交易额</span>
              </div>

              <div className="flex flex-col gap-2 overflow-hidden lg:grid lg:grid-rows-10">
                {(hlTopVolume.length ? hlTopVolume : topGainers).slice(0, 10).map((token, i) => (
                  <div key={i} className="flex h-[36px] items-center justify-between text-sm">
                    <div className="flex items-center gap-2">
                      <span className="truncate text-[13px] text-white">{token.name}</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="text-right text-[13px] tabular-nums text-white">{token.price}</span>
                      <span className="text-right text-[13px] tabular-nums text-[#43e5c9]">
                        {/* @ts-ignore */}
                        {token.volume24h ? formatVolume(token.volume24h) : formatVolume(0)}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            </Card>

            {/* 项目列表 —— 左移一格（col-span-9），并缩小卡片尺寸 */}
            <div className="col-span-1 flex flex-col gap-2 overflow-hidden lg:col-span-9 lg:row-start-2">
              <div className="flex flex-wrap gap-2">
                {categoriesList.map((category) => {
                  const isActive = activeCategory === category
                  const isHot = category === "热门"
                  const isLatest = category === "最新"

                  const base = "rounded-lg border px-3 py-1.5"

                  const hotActive = "bg-orange-500/15 text-orange-400 border-orange-500/30 hover:bg-orange-500/20"
                  const hotInactive = "text-orange-300 border-orange-500/20 hover:bg-orange-500/10"

                  const latestActive = "bg-[#43b8e5]/15 text-[#43b8e5] border-[#43b8e5]/30 hover:bg-[#43b8e5]/20"
                  const latestInactive = "text-[#43b8e5]/80 border-[#43b8e5]/20 hover:bg-[#43b8e5]/10"

                  const normalActive = "bg-[#43e5c9] border-[#43e5c9] text-[#010807]"
                  const normalInactive = "border-[#072027] bg-[#101419] text-white hover:bg-[#072027]"

                  const cls = isHot
                    ? isActive
                      ? `${base} ${hotActive}`
                      : `${base} ${hotInactive}`
                    : isLatest
                      ? isActive
                        ? `${base} ${latestActive}`
                        : `${base} ${latestInactive}`
                      : isActive
                        ? `${base} ${normalActive}`
                        : `${base} ${normalInactive}`

                  return (
                    <button key={category} onClick={() => setActiveCategory(category)} className={cls}>
                      {category}
                    </button>
                  )
                })}
              </div>

              {currentProjects.length === 0 ? (
                <div className="flex flex-col items-center justify-center py-16 text-center">
                  <div className="mb-4 text-6xl">📦</div>
                  <h3 className="mb-2 text-xl font-semibold text-white">暂无项目</h3>
                  <p className="mb-4 text-sm text-[#96fce4]/70">
                    {activeCategory === "全部" ? "请前往管理面板添加项目" : `"${activeCategory}" 分类下暂无项目`}
                  </p>
                  <a href="/admin" target="_blank" rel="noopener noreferrer">
                    <Button className="rounded-lg bg-[#43e5c9] px-6 py-2 text-sm font-medium text-[#010807] hover:bg-[#2da691]">
                      前往管理面板
                    </Button>
                  </a>
                </div>
              ) : (
                <>
                  <div className="grid grid-cols-1 gap-5 overflow-hidden sm:grid-cols-2 lg:grid-cols-3 lg:gap-3">
                    {currentProjects.map((project) => {
                      return (
                        <Card
                          key={project.id}
                          className="flex flex-col overflow-hidden rounded-xl border-[#072027] bg-[#101419] p-2 lg:p-1.5"
                        >
                          <div className="mb-2 flex items-start gap-3 lg:mb-1.5">
                            <img
                              src={project.logo || "/placeholder.svg"}
                              alt={project.name}
                              className="h-8 w-8 flex-shrink-0 rounded-lg object-cover lg:h-7 lg:w-7"
                            />
                            <div className="min-w-0 flex-1">
                              <h3 className="mb-1 truncate text-[14px] lg:text-[13px] font-extrabold leading-tight text-white lg:mb-0.5">
                                {project.name}
                              </h3>
                              <div className="flex flex-wrap gap-2 text-[11px] leading-tight text-[#96fce4]/80 lg:text-[10px]">
                                {project.handle && (
                                  <a
                                    href={
                                      project.links?.twitter ??
                                      (project.handle.startsWith("@")
                                        ? `https://x.com/${project.handle.slice(1)}`
                                        : undefined)
                                    }
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="hover:text-[#43e5c9] underline decoration-dotted"
                                    title="Twitter"
                                  >
                                    {project.handle}
                                  </a>
                                )}

                                {(() => {
                                  const websiteUrl = project?.links?.website ?? project?.website
                                  return websiteUrl ? (
                                    <a
                                      href={toHttp(websiteUrl)}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                      className="hover:text-[#43e5c9] underline decoration-dotted"
                                      title={toHttp(websiteUrl)}
                                    >
                                      官方网站
                                    </a>
                                  ) : null
                                })()}

                                {(() => {
                                  const socialUrl =
                                    project?.links?.social ??
                                    project?.social ??
                                    project?.links?.twitter ??
                                    (project?.handle?.startsWith("@")
                                      ? `https://x.com/${project.handle.slice(1)}`
                                      : undefined)

                                  return socialUrl ? (
                                    <a
                                      href={toHttp(socialUrl)}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                      className="hover:text-[#43e5c9] underline decoration-dotted"
                                      title={toHttp(socialUrl)}
                                    >
                                      社交媒体
                                    </a>
                                  ) : null
                                })()}
                              </div>
                            </div>
                          </div>

                          <div className="mb-2 lg:mb-1.5">
                            <p className="mb-2 text-[11px] leading-relaxed text-[#96fce4]/90 line-clamp-2 lg:mb-1.5 lg:text-[10px]">
                              {project.description}
                            </p>

                            {(project.description ?? "").trim().length > 0 && (
                              <button
                                onClick={() =>
                                  setDescModal({
                                    open: true,
                                    title: project.name,
                                    text: project.description ?? "",
                                  })
                                }
                                className="mb-2 inline-block text-[11px] text-[#43e5c9] hover:underline lg:mb-1.5"
                              >
                                展开全文
                              </button>
                            )}
                          </div>

                          <div className="mt-auto flex flex-wrap gap-1">
                            {(project.categories ?? []).map((cat, i) => {
                              const isHot = cat === "热门"
                              const isLatest = cat === "最新"
                              const color = isHot ? pillHot : isLatest ? pillLatest : pillNormal
                              return (
                                <span key={`c-${i}`} className={`${pillShape} ${pillTypo} ${color}`}>
                                  {cat}
                                </span>
                              )
                            })}

                            {(project.tags ?? []).map((tag, i) => {
                              const isHot = tag === "热门"
                              const isLatest = tag === "最新"
                              const color = isHot ? pillHot : isLatest ? pillLatest : pillNormal
                              return (
                                <span key={`t-${i}`} className={`${pillShape} ${pillTypo} ${color}`}>
                                  {tag}
                                </span>
                              )
                            })}
                          </div>
                          {/* </CHANGE> */}
                        </Card>
                      )
                    })}
                  </div>

                  {/* 分页 */}
                  <div className="flex flex-wrap items-center justify-center gap-2 text-[13px]">
                    <span className="text-[#96fce4]">共 {totalItems} 条</span>

                    <button
                      onClick={goToPreviousPage}
                      disabled={currentPage === 1}
                      className="rounded-lg border border-[#072027] bg-[#101419] px-2.5 py-1 text-white hover:bg-[#072027] disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      &lt;
                    </button>

                    <div className="hidden gap-2 sm:flex">
                      {getVisiblePageNumbers().map((page, i) =>
                        page === "..." ? (
                          <span key={`ellipsis-${i}`} className="px-2.5 py-1 text-[#96fce4]">
                            ...
                          </span>
                        ) : (
                          <button
                            key={page}
                            onClick={() => goToSpecificPage(page as number)}
                            className={`rounded-lg px-2.5 py-1 ${
                              page === currentPage
                                ? "bg-[#43e5c9] text-[#010807]"
                                : "border border-[#072027] bg-[#101419] text-white hover:bg-[#072027]"
                            }`}
                          >
                            {page}
                          </button>
                        ),
                      )}
                    </div>

                    <div className="flex gap-2 sm:hidden">
                      {getVisiblePageNumbers()
                        .slice(0, 3)
                        .map((page, i) =>
                          page === "..." ? (
                            <span key={`ellipsis-m-${i}`} className="px-2.5 py-1 text-[#96fce4]">
                              ...
                            </span>
                          ) : (
                            <button
                              key={page}
                              onClick={() => goToSpecificPage(page as number)}
                              className={`rounded-lg px-2.5 py-1 ${
                                page === currentPage
                                  ? "bg-[#43e5c9] text-[#010807]"
                                  : "border border-[#072027] bg-[#101419] text-white hover:bg-[#072027]"
                              }`}
                            >
                              {page}
                            </button>
                          ),
                        )}
                    </div>

                    <button
                      onClick={goToNextPage}
                      disabled={currentPage === totalPages}
                      className="rounded-lg border border-[#072027] bg-[#101419] px-2.5 py-1 text-white hover:bg-[#072027] disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      &gt;
                    </button>

                    <div className="hidden items-center gap-2 sm:flex">
                      <span className="text-[#96fce4]">前往</span>
                      <input
                        type="number"
                        min="1"
                        max={totalPages}
                        value={goToPage}
                        onChange={(e) => setGoToPage(e.target.value)}
                        onKeyDown={(e) => e.key === "Enter" && handleGoToPageSubmit()}
                        className="w-10 rounded-lg border border-[#072027] bg-[#101419] px-2 py-1 text-center text-white"
                        placeholder={currentPage.toString()}
                      />
                      <span className="text-[#96fce4]">页</span>
                    </div>
                  </div>
                </>
              )}
            </div>
            {/* /项目列表 */}
          </div>
        </div>
      </main>

      {/* Footer with copyright text */}
      <footer className="border-t border-[#072027] bg-[#010807] py-4 text-center">
        <p className="text-xs text-[#96fce4]/60">© 2025 Hyperliquid中文社区 All rights reserved.</p>
      </footer>

      {descModal.open && (
        <div
          className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 p-4"
          onClick={() => setDescModal({ open: false, title: "", text: "" })}
        >
          <div
            className="w-full max-w-2xl rounded-xl border border-[#072027] bg-[#101419] p-4 shadow-xl"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="mb-3 flex items-center justify-between">
              <h3 className="text-base font-semibold text-white">{descModal.title || "项目简介"}</h3>
              <button
                className="rounded-md border border-[#072027] px-2 py-1 text-[12px] text-[#96fce4] hover:bg-[#072027]"
                onClick={() => setDescModal({ open: false, title: "", text: "" })}
              >
                关闭
              </button>
            </div>

            <div className="max-h-[60vh] overflow-auto pr-1">
              <p className="whitespace-pre-wrap text-[13px] leading-6 text-[#96fce4]">{descModal.text}</p>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
